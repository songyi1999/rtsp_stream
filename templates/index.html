<!DOCTYPE html>
<html>
<head>
    <title>RTSP Stream Player</title>
    <style>
        #canvas {
            width: 800px;
            height: 600px;
        }
    </style>
</head>
<body>
    <div>
        <input type="text" id="rtspUrl" placeholder="输入RTSP地址" style="width: 300px;">
        <button onclick="startStream()">开始播放</button>
        <button onclick="stopStream()">停止播放</button>
    </div>
    <canvas id="canvas"></canvas>
    
    <script type="text/javascript" src="/static/jsmpeg.min.js"></script>
    <script type="text/javascript">
        let player = null;
        const wsPort = 9999;

        async function startStream() {
            const rtspUrl = document.getElementById('rtspUrl').value;
            
            try {
                const response = await fetch('/stream/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rtsp_url: rtspUrl,
                        ws_port: wsPort
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    console.log('连接WebSocket:', data.ws_url);
                    player = new JSMpeg.Player(data.ws_url, {
                        canvas: document.getElementById('canvas')
                    });
                } else {
                    alert('启动失败: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('请求失败: ' + error.message);
            }
        }

        async function stopStream() {
            if (player) {
                try {
                    const response = await fetch('/stream/stop', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ws_port: wsPort
                        })
                    });
                    
                    const data = await response.json();
                    if (data.status === 'success') {
                        player.destroy();
                        player = null;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('停止失败: ' + error.message);
                }
            }
        }
    </script>
</body>
</html> 